USE master
CREATE DATABASE QLQA
GO
USE QLQA
CREATE TABLE KHACHHANG
(
	MAKH INT IDENTITY(1,1),
	TENKH NVARCHAR(30),
	DIACHI NVARCHAR(30),
	GIOITINH NCHAR(5),
	EMAIL NVARCHAR(30),
	TENDN CHAR(20),
	MATKHAU CHAR(20),
	PRIMARY KEY(MAKH)
)
INSERT INTO KHACHHANG(TENKH, DIACHI, GIOITINH, EMAIL, TENDN, MATKHAU)
VALUES(N'Lê Quang Trung',N'TP.HCM',N'Nam','trung@gmail.com','trung','123')

INSERT INTO KHACHHANG(TENKH, DIACHI, GIOITINH, EMAIL, TENDN, MATKHAU)
VALUES(N'Nguyễn Thị Kim Nhung',N'TP.HCM',N'Nữ','nhung@gmail.com','nhung','456')

INSERT INTO KHACHHANG(TENKH, DIACHI, GIOITINH, EMAIL, TENDN, MATKHAU)
VALUES(N'Phạm Hoàng Sơn',N'Tây Ninh',N'Nam','son@gmail.com','son','789')

CREATE TABLE LOAI
(
	MALOAI INT,
	TENLOAI NVARCHAR(50)
	PRIMARY KEY(MALOAI)
)
INSERT INTO LOAI VALUES(1,N'T-Shirts & Polos')
INSERT INTO LOAI VALUES(2,N'Hoodies')
INSERT INTO LOAI VALUES(3,N'Backpacks')
INSERT INTO LOAI VALUES(4,N'Accessories')
INSERT INTO LOAI VALUES(5,N'Pants & Shorts')
INSERT INTO LOAI VALUES(6,N'Jackets')
SELECT * FROM LOAI
CREATE TABLE SANPHAM
(
	MASP INT,
	TENSP NVARCHAR(50),
	DONGIA FLOAT,
	HINHANH NVARCHAR(30),
	MALOAI INT,
	PRIMARY KEY(MASP)
)
ALTER TABLE SANPHAM
ADD CONSTRAINT FK_SP_LOAI FOREIGN KEY(MALOAI) REFERENCES LOAI(MALOAI)

INSERT INTO SANPHAM VALUES(1,N'MONARCH BUTTERFLY T-SHIRT',400000,N'ts01.png',1)
INSERT INTO SANPHAM VALUES(2,N'GRYNCH T-SHIRT',259000,N'ts02.png',1)
INSERT INTO SANPHAM VALUES(3,N'SPACE PROGRAM T-SHIRT',290000,N'ts03.png',1)
INSERT INTO SANPHAM VALUES(4,N'IM HAPPY T-SHIRT',350000,N'ts04.png',1)
INSERT INTO SANPHAM VALUES(5,N'HOLOGRAM MERCURY TIE-DYE T-SHIRT',450000,N'ts05.png',1)
INSERT INTO SANPHAM VALUES(6,N'POLO ACADEMY',390000,N'ts06.png',1)
INSERT INTO SANPHAM VALUES(7,N'ACADEMY DCS T-SHIRT',350000,N'ts07.png',1)
INSERT INTO SANPHAM VALUES(8,N'DIRTYCOINS BASIC CASUAL T-SHIRT',190000,N'ts08.png',1)

INSERT INTO SANPHAM VALUES(9,N'HOODIE BIG LOGO SEASON 2020',549000,N'hd01.png',2)
INSERT INTO SANPHAM VALUES(10,N'SOTY HOODIE',650000,N'hd02.png',2)
INSERT INTO SANPHAM VALUES(11,N'HOODIES TIE-DYE',700000,N'hd03.png',2)
INSERT INTO SANPHAM VALUES(12,N'UNICORN HOODIE',550000,N'hd04.png',2)
INSERT INTO SANPHAM VALUES(13,N'DIRTY COINS ANGEL HOODIE',250000,N'hd05.png',2)
INSERT INTO SANPHAM VALUES(14,N'BREAKING NEWS HD',349000,N'hd06.png',2)
INSERT INTO SANPHAM VALUES(15,N'GRYNCH HOODIE',290000,N'hd07.png',2)
INSERT INTO SANPHAM VALUES(16,N'ACADEMY ZIPPED HOODIE',349000,N'hd08.png',2)

INSERT INTO SANPHAM VALUES(17,N'LOGO PATTERN BACKPACK - BLACK',800000,N'pb01.png',3)
INSERT INTO SANPHAM VALUES(18,N'ACADEMY BACKPACK',700000,N'pb02.png',3)
INSERT INTO SANPHAM VALUES(19,N'DIRTY COINS ANGEL BACKPACK',500000,N'pb03.png',3)
INSERT INTO SANPHAM VALUES(20,N'SPACE PROGRAM ASTRO BACKPACK',730000,N'pb04.png',3)
INSERT INTO SANPHAM VALUES(21,N'SPACE PROGRAM CROSS BAG',349000,N'pb05.png',3)
INSERT INTO SANPHAM VALUES(22,N'THE SPHYNX PYRAMID BACKPACK',390000,N'pb06.png',3)
INSERT INTO SANPHAM VALUES(23,N'MINI-UZI CROSSBODY BAGS',299000,N'pb07.png',3)
INSERT INTO SANPHAM VALUES(24,N'DIRTYCOINS MINI CROSSBODY BAGS',299000,N'pb08.png',3)

INSERT INTO SANPHAM VALUES(25,N'DIRTYCOINS WALLY WALLET',290000,N'as01.png',4)
INSERT INTO SANPHAM VALUES(26,N'DIRTYCOINS HEADBAND - BLACK',143900,N'as02.png',4)
INSERT INTO SANPHAM VALUES(27,N'SIGNATURE Y ZIPPED WALLET',275000,N'as03.png',4)
INSERT INTO SANPHAM VALUES(28,N'CROCS SHORT WALLET',190000,N'as04.png',4)
INSERT INTO SANPHAM VALUES(29,N'CROCS LONG WALLET ',600000,N'as05.png',4)
INSERT INTO SANPHAM VALUES(30,N'SPRING OF THE Y SOCKS',90000,N'as06.png',4)
INSERT INTO SANPHAM VALUES(31,N'BASIC BEANIES',189000,N'as07.png',4)
INSERT INTO SANPHAM VALUES(32,N'DIRTY COINS LOGO CAP',239000,N'as08.png',4)

INSERT INTO SANPHAM VALUES(33,N'PLAID PANTS IN BRED',450000,N'ps01.png',5)
INSERT INTO SANPHAM VALUES(34,N'GRYNCH ALL OVER PRINT PANTS',500000,N'ps02.png',5)
INSERT INTO SANPHAM VALUES(35,N'YOSHINO DRAGON SHORTS',520000,N'ps03.png',5)
INSERT INTO SANPHAM VALUES(36,N'Y SHORT',329000,N'ps04.png',5)
INSERT INTO SANPHAM VALUES(37,N'ACADEMY UNIFORM PANTS',500000,N'ps05.png',5)
INSERT INTO SANPHAM VALUES(38,N'DIRTY COINS SWEAT TRACK PANTS ',440000,N'ps06.png',5)
INSERT INTO SANPHAM VALUES(39,N'DCS SHORT',315000,N'ps07.png',5)
INSERT INTO SANPHAM VALUES(40,N'DIRTYCOINS SWEAT SHORTS ',390000,N'ps08.png',5)

INSERT INTO SANPHAM VALUES(41,N'MONARCH ALL OVER PRINT JACKET',650000,N'jk01.png',6)
INSERT INTO SANPHAM VALUES(42,N'HOLOGRAM ZIP JACKETS',620000,N'jk02.png',6)
INSERT INTO SANPHAM VALUES(43,N'SIGNATURE Y ZIP COACH JACKET',600000,N'jk03.png',6)
INSERT INTO SANPHAM VALUES(44,N'REFLECTIVE LOGO SWEAT TRACK JACKETS ',209000,N'jk04.png',6)
INSERT INTO SANPHAM VALUES(45,N'Y - SPACE JACKET',339000,N'jk05.png',6)
INSERT INTO SANPHAM VALUES(46,N'DIRTY COINS EYES-CREAM JACKET',490000,N'jk06.png',6)
INSERT INTO SANPHAM VALUES(47,N'TRACK JACKET ',450000,N'jk07.png',6)
INSERT INTO SANPHAM VALUES(48,N'ALL OVER PRINT DALAT COACH JACKET',550000,N'jk08.png',6)
SELECT * FROM SANPHAM

CREATE TABLE HOADON
(
	MAHD INT Identity(1,1),
	NGAYLAP DATE,
	MAKH INT,
	THANHTIEN MONEY,
	PRIMARY KEY(MAHD)
)

ALTER TABLE HOADON
ADD CONSTRAINT FK_HD_KH FOREIGN KEY(MAKH) REFERENCES KHACHHANG(MAKH)

CREATE TABLE CHITIETHD
(
	MAHD INT,
	MASP INT,
	SOLUONG INT,
	TONGTIEN MONEY,
	PRIMARY KEY(MAHD, MASP)
)
ALTER TABLE CHITIETHD
ADD CONSTRAINT FK_CT_SP FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP),
	CONSTRAINT FK_CT_HD FOREIGN KEY(MAHD) REFERENCES HOADON(MAHD)

create trigger capnhatTongTien on CHITIETHD
FOR INSERT, UPDATE
AS
	UPDATE CHITIETHD
	SET TONGTIEN = SOLUONG * (SELECT DONGIA FROM SANPHAM WHERE SANPHAM.MASP = (SELECT MASP FROM inserted))
	WHERE CHITIETHD.MAHD = (SELECT MAHD FROM inserted)
	AND CHITIETHD.MASP = (SELECT MASP FROM inserted)

	UPDATE HOADON
	SET THANHTIEN = (SELECT SUM(TONGTIEN) FROM CHITIETHD WHERE CHITIETHD.MAHD = (SELECT MAHD FROM inserted))
	WHERE HOADON.MAHD = (SELECT MAHD FROM inserted)
GO
